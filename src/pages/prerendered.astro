---
import Layout from '../layouts/Layout.astro'
import LoadingSpinner from '../components/LoadingSpinner.astro'
import UserFromAPI from '../components/UserFromAPI.astro'
import { SignedIn, SignedOut, Protect } from '@clerk/astro/components'

export const prerender = true
---

<Layout title="Prerendered with Server Islands">
  <main class="max-w-4xl mx-auto p-8">
    <h1 class="text-2xl font-bold mb-2">Prerendered Page</h1>
    <p class="text-sm text-gray-600 mb-8">
      <code class="bg-gray-100 px-1 rounded">export const prerender = true</code>
    </p>

    <div class="space-y-6">
      <div>
        <h2 class="font-semibold mb-3">SignedIn / SignedOut</h2>
        <div class="space-y-4">
          <SignedIn server:defer>
            <div class="border border-green-500 rounded p-4">
              <p class="font-semibold">✓ Signed In</p>
              <p class="text-sm text-gray-600">Server island checked auth at request time</p>
            </div>
            <div slot="fallback" class="border rounded p-4">
              <LoadingSpinner />
            </div>
          </SignedIn>

          <SignedOut server:defer>
            <div class="border border-yellow-500 rounded p-4">
              <p class="font-semibold">→ Signed Out</p>
              <p class="text-sm text-gray-600 mb-2">Server island checked auth at request time</p>
              <a href="/signin" class="text-blue-600 text-sm hover:underline">Sign In</a>
            </div>
            <div slot="fallback" class="border rounded p-4">
              <LoadingSpinner />
            </div>
          </SignedOut>
        </div>
      </div>

      <div>
        <h2 class="font-semibold mb-3">Protect - Role: "admin"</h2>
        <Protect role="admin" server:defer>
          <div class="border border-green-500 rounded p-4">
            <p class="font-semibold">✓ Authorized</p>
            <p class="text-sm text-gray-600">You have the admin role</p>
          </div>
          <div slot="protect-fallback" class="border border-red-500 rounded p-4">
            <p class="font-semibold">⚠️ Access Denied</p>
            <p class="text-sm text-gray-600">Admin role required</p>
          </div>
          <div slot="fallback" class="border rounded p-4">
            <LoadingSpinner />
          </div>
        </Protect>
      </div>

      <div>
        <h2 class="font-semibold mb-3">Protect - Permission: "org:reports:read"</h2>
        <Protect permission="org:reports:read" server:defer>
          <div class="border border-green-500 rounded p-4">
            <p class="font-semibold">✓ Authorized</p>
            <p class="text-sm text-gray-600">You have the permission</p>
          </div>
          <div slot="protect-fallback" class="border border-red-500 rounded p-4">
            <p class="font-semibold">⚠️ Access Denied</p>
            <p class="text-sm text-gray-600">Permission required</p>
          </div>
          <div slot="fallback" class="border rounded p-4">
            <LoadingSpinner />
          </div>
        </Protect>
      </div>

      <div>
        <h2 class="font-semibold mb-3">API Route - Server-to-Server</h2>
        <UserFromAPI server:defer>
          <div slot="fallback" class="border rounded p-4">
            <LoadingSpinner />
          </div>
        </UserFromAPI>
      </div>
    </div>
  </main>
</Layout>
